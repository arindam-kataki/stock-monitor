<!-- src/app/features/analytics/analytics.html -->

<div class="analytics-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <mat-icon>analytics</mat-icon>
        Stock Analytics
      </h1>
      <p class="subtitle">
        Compare performance and analyze trends across your portfolio
      </p>
    </div>

    <div class="header-actions">
      <button mat-stroked-button (click)="exportData()">
        <mat-icon>download</mat-icon>
        Export
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading analytics data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-card class="error-card">
      <mat-icon>error_outline</mat-icon>
      <h3>{{ error }}</h3>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div
    *ngIf="!loading && !error && ribbons.length > 0"
    class="analytics-content"
  >
    <!-- Universal Controls Bar -->
    <mat-card class="controls-card">
      <div class="controls-row">
        <!-- Ribbon Selection -->
        <div class="control-group flex-3">
          <label>Select Watches:</label>
          <mat-select
            [(ngModel)]="selectedRibbons"
            (selectionChange)="onRibbonSelectionChange()"
            multiple
            placeholder="Choose watches to compare"
          >
            <mat-option *ngFor="let ribbon of ribbons" [value]="ribbon">
              <mat-icon>{{ ribbon.icon }}</mat-icon>
              {{ ribbon.name }} ({{ ribbon.selectedStocks.length }} stocks)
            </mat-option>
          </mat-select>
        </div>

        <!-- Time Range -->
        <div class="control-group flex-2">
          <label>Time Range:</label>
          <div class="time-range-selector">
            <button
              *ngFor="let range of timeRanges"
              mat-button
              [class.active]="range === selectedTimeRange"
              (click)="onTimeRangeChange(range)"
            >
              {{ range }}
            </button>
          </div>
        </div>

        <!-- End Date Picker -->
        <div class="control-group">
          <label>Ends On:</label>
          <div class="end-date-controls">
            <mat-form-field appearance="outline" class="date-picker-field">
              <input
                matInput
                [matDatepicker]="endDatePicker"
                [value]="customEndDate"
                [max]="maxDate"
                [matDatepickerFilter]="dateFilter"
                (dateChange)="onEndDateChange($event.value)"
                placeholder="Select end date"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="endDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #endDatePicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>

        <!-- View Selector Dropdown -->
        <div class="control-group">
          <label>View:</label>
          <mat-select
            [(ngModel)]="viewMode"
            (selectionChange)="onViewModeChange(viewMode)"
            class="view-selector"
          >
            <mat-option value="comparison">
              <mat-icon>show_chart</mat-icon>
              <span>Comparison</span>
            </mat-option>
            <mat-option value="heatmap">
              <mat-icon>grid_on</mat-icon>
              <span>Heatmap</span>
            </mat-option>
            <mat-option value="correlation">
              <mat-icon>scatter_plot</mat-icon>
              <span>Correlation</span>
            </mat-option>
          </mat-select>
        </div>

        <!-- Sort By Dropdown (disabled when not in heatmap view) -->
        <div class="control-group">
          <label>Sort By:</label>
          <mat-select
            [(ngModel)]="heatmapSortBy"
            (selectionChange)="sortHeatmap()"
            [disabled]="viewMode !== 'heatmap'"
            class="sort-selector"
          >
            <mat-option value="change">
              <mat-icon>trending_up</mat-icon>
              <span>Performance</span>
            </mat-option>
            <mat-option value="volume">
              <mat-icon>bar_chart</mat-icon>
              <span>Volume</span>
            </mat-option>
            <mat-option value="alphabetical">
              <mat-icon>sort_by_alpha</mat-icon>
              <span>Alphabetical</span>
            </mat-option>
          </mat-select>
        </div>
      </div>

      <!-- Selected Stocks Chips with S&P Toggle -->
      <div class="selected-stocks-row" *ngIf="selectedStocks.length > 0">
        <div class="stocks-info">
          <label>Comparing {{ selectedStocks.length }} stocks:</label>
          <mat-chip-set class="stock-chips">
            <mat-chip *ngFor="let stock of selectedStocks">
              {{ stock.symbol }}
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- S&P 500 Benchmark Toggle (moved here, only show for comparison view) -->
        <div class="benchmark-toggle" *ngIf="viewMode === 'comparison'">
          <mat-slide-toggle
            [(ngModel)]="showBenchmark"
            [disabled]="true"
            (change)="toggleBenchmark()"
            color="primary"
          >
            <mat-icon>insights</mat-icon>
            Add S&P 500 Benchmark
          </mat-slide-toggle>
        </div>
      </div>
    </mat-card>

    <div
      *ngIf="
        !loading && !error && ribbons.length > 0 && selectedRibbons.length > 0
      "
      class="analytics-content"
    >
      <!-- Comparison View -->
      <div *ngIf="viewMode === 'comparison'" class="comparison-view">
        <!-- Metrics Row -->
        <!-- Update the Metrics Row in analytics.html -->
        <div class="metrics-row">
          <mat-card class="metric-card compact">
            <mat-card-content>
              <mat-icon class="metric-icon" matTooltip="Average Change"
                >trending_flat</mat-icon
              >
              <div
                class="metric-value"
                [class.positive]="averageChange > 0"
                [class.negative]="averageChange < 0"
              >
                {{ formatChange(averageChange) }}
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="metric-card compact" *ngIf="topPerformer">
            <mat-card-content>
              <mat-icon class="metric-icon top" matTooltip="Top Performer"
                >trending_up</mat-icon
              >
              <div class="metric-inline">
                <span class="metric-stock">{{ topPerformer.symbol }}</span>
                <span class="metric-value positive">{{
                  formatChange(topPerformerChange)
                }}</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="metric-card compact" *ngIf="bottomPerformer">
            <mat-card-content>
              <mat-icon class="metric-icon bottom" matTooltip="Bottom Performer"
                >trending_down</mat-icon
              >
              <div class="metric-inline">
                <span class="metric-stock">{{ bottomPerformer.symbol }}</span>
                <span class="metric-value negative">{{
                  formatChange(bottomPerformerChange)
                }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Comparison Chart -->
        <!-- Update this section in analytics.html -->

        <!-- Comparison Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <div class="chart-header-content">
              <div>
                <mat-card-title
                  >Normalized Performance Comparison</mat-card-title
                >
                <mat-card-subtitle>
                  {{ getDateRangeString() }} • All values indexed to 0% at start
                </mat-card-subtitle>
              </div>
              <div class="chart-resize-controls">
                <button
                  mat-icon-button
                  class="resize-btn"
                  (click)="decreaseChartSize()"
                  [disabled]="chartSize === 'small'"
                  matTooltip="Decrease size"
                >
                  <mat-icon>remove</mat-icon>
                </button>
                <button
                  mat-icon-button
                  class="resize-btn"
                  (click)="resetChartSize()"
                  matTooltip="Reset size"
                >
                  <mat-icon>aspect_ratio</mat-icon>
                </button>
                <button
                  mat-icon-button
                  class="resize-btn"
                  (click)="increaseChartSize()"
                  [disabled]="chartSize === 'large'"
                  matTooltip="Increase size"
                >
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>
          </mat-card-header>

          <mat-card-content>
            <div class="chart-container" [ngClass]="'chart-' + chartSize">
              <canvas #comparisonChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Heatmap View -->
      <div *ngIf="viewMode === 'heatmap'" class="heatmap-view">
        <!-- Heatmap Grid -->
        <mat-card class="heatmap-card">
          <mat-card-header>
            <mat-card-title>Performance Heatmap</mat-card-title>
            <mat-card-subtitle>
              {{ selectedTimeRange }} performance across all selected stocks
              <span class="sort-indicator"
                >• Sorted by {{ getSortLabel() }}</span
              >
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <!-- Heatmap Legend -->
            <div class="heatmap-legend">
              <span class="legend-item">
                <span class="legend-color strong-positive"></span>
                > +5%
              </span>
              <span class="legend-item">
                <span class="legend-color positive"></span>
                +2% to +5%
              </span>
              <span class="legend-item">
                <span class="legend-color slight-positive"></span>
                0% to +2%
              </span>
              <span class="legend-item">
                <span class="legend-color slight-negative"></span>
                0% to -2%
              </span>
              <span class="legend-item">
                <span class="legend-color negative"></span>
                -2% to -5%
              </span>
              <span class="legend-item">
                <span class="legend-color strong-negative"></span>
                < -5%
              </span>
            </div>

            <!-- Heatmap Grid -->
            <div class="heatmap-grid" *ngIf="heatmapData.length > 0">
              <div
                *ngFor="let cell of heatmapData"
                class="heatmap-cell"
                [ngClass]="getHeatmapColor(cell.change)"
                [matTooltip]="cell.name + ' - ' + formatChange(cell.change)"
                matTooltipPosition="above"
              >
                <div class="cell-symbol">{{ cell.symbol }}</div>
                <div class="cell-change">{{ formatChange(cell.change) }}</div>
                <div class="cell-volume">
                  Vol: {{ formatVolume(cell.volume) }}
                </div>
              </div>
            </div>

            <!-- No Data Message -->
            <div *ngIf="heatmapData.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>Select watches to view heatmap</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Correlation View -->
      <!-- Replace the Correlation View section in analytics.html with this: -->

      <!-- Correlation View -->
      <div *ngIf="viewMode === 'correlation'" class="correlation-view">
        <mat-card class="correlation-card">
          <mat-card-header>
            <mat-card-title>Correlation Matrix</mat-card-title>
            <mat-card-subtitle>
              Analyzing {{ correlationLabels.length }} stocks over
              {{ selectedTimeRange }} period
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <!-- Correlation content when we have data -->
            <div *ngIf="correlationMatrix.length >= 2">
              <!-- Legend -->
              <div class="correlation-legend">
                <div class="legend-title">Correlation Strength:</div>
                <div class="legend-items">
                  <span class="legend-item">
                    <span class="legend-color strong-positive-corr"></span>
                    Strong Positive (70% to 100%)
                  </span>
                  <span class="legend-item">
                    <span class="legend-color moderate-positive-corr"></span>
                    Moderate Positive (30% to 70%)
                  </span>
                  <span class="legend-item">
                    <span class="legend-color weak-corr"></span>
                    Weak (-30% to 30%)
                  </span>
                  <span class="legend-item">
                    <span class="legend-color moderate-negative-corr"></span>
                    Moderate Negative (-70% to -30%)
                  </span>
                  <span class="legend-item">
                    <span class="legend-color strong-negative-corr"></span>
                    Strong Negative (-100% to -70%)
                  </span>
                </div>
              </div>

              <!-- Chart Container -->
              <div class="chart-container">
                <canvas #correlationChart></canvas>
              </div>

              <!-- Correlation Insights -->
              <div class="correlation-insights">
                <h4>Key Insights:</h4>
                <div class="insights-grid">
                  <div class="insight-card">
                    <mat-icon>trending_up</mat-icon>
                    <div class="insight-content">
                      <div class="insight-label">Most Correlated Pair</div>
                      <div
                        class="insight-value"
                        *ngIf="getMostCorrelatedPair() as pair"
                      >
                        {{ pair.stock1 }} & {{ pair.stock2 }}
                        <span class="correlation-value positive">{{
                          formatCorrelation(pair.correlation)
                        }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="insight-card">
                    <mat-icon>trending_down</mat-icon>
                    <div class="insight-content">
                      <div class="insight-label">Most Diversified Pair</div>
                      <div
                        class="insight-value"
                        *ngIf="getLeastCorrelatedPair() as pair"
                      >
                        {{ pair.stock1 }} & {{ pair.stock2 }}
                        <span class="correlation-value negative">{{
                          formatCorrelation(pair.correlation)
                        }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="insight-card">
                    <mat-icon>analytics</mat-icon>
                    <div class="insight-content">
                      <div class="insight-label">Portfolio Diversity</div>
                      <div class="insight-value">
                        {{ getPortfolioDiversityScore() }}
                        <span class="diversity-label">{{
                          getDiversityLabel()
                        }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Not enough stocks message -->
            <div
              *ngIf="correlationMatrix.length < 2 && selectedStocks.length > 0"
              class="insufficient-data"
            >
              <mat-icon>info</mat-icon>
              <h3>Insufficient Data</h3>
              <p>Select at least 2 stocks to view correlation analysis</p>
            </div>

            <!-- No stocks selected -->
            <div *ngIf="selectedStocks.length === 0" class="no-data">
              <mat-icon>scatter_plot</mat-icon>
              <h3>No Stocks Selected</h3>
              <p>Select watches to analyze stock correlations</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>

  <!-- Empty State 2: Watches exist but none selected -->
  <div
    *ngIf="
      !loading && !error && ribbons.length > 0 && selectedRibbons.length === 0
    "
    class="analytics-section"
  >
    <div class="empty-state">
      <mat-icon class="empty-icon">touch_app</mat-icon>
      <h3>No watches selected</h3>
      <p>
        Select one or more watches from the controls above to begin analysis
      </p>
    </div>
  </div>

  <div
    *ngIf="!loading && !error && ribbons.length === 0"
    class="analytics-section"
  >
    <div class="empty-state">
      <mat-icon class="empty-icon">visibility_off</mat-icon>
      <h3>No watches configured yet</h3>
      <p>Add a watch with stocks to start analyzing stocks</p>
    </div>
  </div>
</div>
