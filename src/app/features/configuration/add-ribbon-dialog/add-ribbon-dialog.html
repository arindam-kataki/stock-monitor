<!-- src/app/features/configuration/add-ribbon-dialog/add-ribbon-dialog.html -->

<h2 mat-dialog-title>
  <mat-icon>{{ isEditMode ? "edit" : "add_circle" }}</mat-icon>
  {{ isEditMode ? "Edit" : "Create New" }} Watch List
</h2>

<mat-dialog-content>
  <form [formGroup]="ribbonForm">
    <!-- Ribbon Name -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Watch List Name</mat-label>
      <input
        matInput
        formControlName="name"
        placeholder="e.g., Tech Growth, Banking Sector"
        #nameInput
        autocomplete="off"
      />
      <mat-icon matSuffix>label</mat-icon>
      <mat-hint>Give your watch list a descriptive name</mat-hint>
      <mat-error *ngIf="ribbonForm.get('name')?.hasError('required')">
        Name is required
      </mat-error>
      <mat-error *ngIf="ribbonForm.get('name')?.hasError('minlength')">
        Name must be at least 2 characters
      </mat-error>
    </mat-form-field>

    <!-- Category Selection -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Category Template</mat-label>
      <mat-select formControlName="categoryId">
        <mat-option *ngFor="let category of categories" [value]="category.id">
          <span class="category-option">
            <span class="category-icon">{{ category.icon }}</span>
            <span class="category-name">{{ category.name }}</span>
            <span class="stock-count"
              >({{ category.stocks.length }} stocks)</span
            >
          </span>
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>category</mat-icon>
      <mat-hint>Choose a category to see available stocks</mat-hint>
      <mat-error *ngIf="ribbonForm.get('categoryId')?.hasError('required')">
        Please select a category
      </mat-error>
    </mat-form-field>

    <!-- Stock Selection Section -->
    <div class="stocks-section" *ngIf="selectedCategory">
      <!-- Header with controls -->
      <div class="stocks-header">
        <h3>
          Select Stocks & Set Alerts
          <mat-chip class="selection-chip">
            {{ selectedStockCount }} / {{ totalStockCount }} selected
          </mat-chip>
        </h3>

        <div class="stock-controls">
          <!-- Search -->
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search stocks</mat-label>
            <input
              matInput
              [(ngModel)]="searchQuery"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Symbol or name..."
            />
            <button
              mat-icon-button
              matSuffix
              *ngIf="searchQuery"
              (click)="clearSearch()"
            >
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>

          <!-- View Toggle -->
          <button
            mat-stroked-button
            (click)="toggleView()"
            matTooltip="Toggle between grid and list view"
          >
            <mat-icon>{{
              viewMode === "grid" ? "view_list" : "view_module"
            }}</mat-icon>
            {{ viewMode === "grid" ? "List View" : "Grid View" }}
          </button>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <button
              mat-stroked-button
              (click)="showOnlySelected = !showOnlySelected"
              [color]="showOnlySelected ? 'primary' : ''"
            >
              <mat-icon>{{
                showOnlySelected ? "visibility" : "visibility_off"
              }}</mat-icon>
              Show Selected
            </button>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <mat-progress-bar
        mode="determinate"
        [value]="selectionProgress"
        class="selection-progress"
      ></mat-progress-bar>

      <!-- Stock Grid/List View -->
      <div [ngClass]="viewMode === 'grid' ? 'stock-grid' : 'stock-list'">
        <div
          *ngFor="let stock of filteredStocks"
          [ngClass]="
            viewMode === 'grid' ? 'stock-item-grid' : 'stock-item-list'
          "
          [class.selected]="isStockSelected(stock.symbol)"
        >
          <!-- Checkbox and Stock Info -->
          <div class="stock-main-section">
            <mat-checkbox
              [checked]="isStockSelected(stock.symbol)"
              (change)="toggleStock(stock.symbol)"
              class="stock-checkbox"
            >
              <div class="stock-info">
                <span class="stock-symbol">{{ stock.symbol }}</span>
                <span class="stock-name">{{ stock.name }}</span>
                <div class="stock-meta" *ngIf="stock.sector">
                  <mat-icon class="tiny-icon">business</mat-icon>
                  <span>{{ stock.sector }}</span>
                </div>
              </div>
            </mat-checkbox>
          </div>

          <!-- Alert Settings (shown when stock is selected) -->
          <div
            class="alert-settings"
            *ngIf="isStockSelected(stock.symbol)"
            [@expandCollapse]
          >
            <!-- High Value Alert -->
            <div class="alert-input-group">
              <mat-checkbox
                [(ngModel)]="stockSelections[stock.symbol].highEnabled"
                [ngModelOptions]="{ standalone: true }"
                class="alert-checkbox"
              >
                <mat-icon class="alert-icon high">trending_up</mat-icon>
              </mat-checkbox>
              <mat-form-field appearance="outline" class="alert-field">
                <mat-label>High Alert</mat-label>
                <input
                  matInput
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  [(ngModel)]="stockSelections[stock.symbol].highValue"
                  [ngModelOptions]="{ standalone: true }"
                  [disabled]="!stockSelections[stock.symbol].highEnabled"
                />
                <span matPrefix>$</span>
                <mat-hint>Alert when price goes above</mat-hint>
              </mat-form-field>
            </div>

            <!-- Low Value Alert -->
            <div class="alert-input-group">
              <mat-checkbox
                [(ngModel)]="stockSelections[stock.symbol].lowEnabled"
                [ngModelOptions]="{ standalone: true }"
                class="alert-checkbox"
              >
                <mat-icon class="alert-icon low">trending_down</mat-icon>
              </mat-checkbox>
              <mat-form-field appearance="outline" class="alert-field">
                <mat-label>Low Alert</mat-label>
                <input
                  matInput
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  [(ngModel)]="stockSelections[stock.symbol].lowValue"
                  [ngModelOptions]="{ standalone: true }"
                  [disabled]="!stockSelections[stock.symbol].lowEnabled"
                />
                <span matPrefix>$</span>
                <mat-hint>Alert when price goes below</mat-hint>
              </mat-form-field>
            </div>

            <!-- Current Price Reference -->
            <div class="current-price" *ngIf="stock.price">
              <span class="price-label">Current:</span>
              <span class="price-value"
                >${{ stock.price | number : "1.2-2" }}</span
              >
            </div>
          </div>
        </div>

        <!-- No results message -->
        <div *ngIf="filteredStocks.length === 0" class="no-results">
          <mat-icon>search_off</mat-icon>
          <p>No stocks found matching your criteria</p>
        </div>
      </div>

      <!-- Quick Selection Chips -->
      <div class="quick-select-chips">
        <span class="chip-label">Quick select:</span>
        <mat-chip-listbox>
          <mat-chip-option (click)="selectTopN(5)">Top 5</mat-chip-option>
          <mat-chip-option (click)="selectTopN(10)">Top 10</mat-chip-option>
          <mat-chip-option (click)="selectByPattern('inverse')"
            >Invert</mat-chip-option
          >
          <mat-chip-option (click)="deselectAll()" color="warn"
            >Clear All</mat-chip-option
          >
        </mat-chip-listbox>
      </div>
    </div>

    <!-- Warning if no stocks selected -->
    <div
      class="warning-message"
      *ngIf="selectedCategory && selectedStockCount === 0"
    >
      <mat-icon>warning</mat-icon>
      <span>Please select at least one stock to create the watch list</span>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="!isFormValid"
  >
    <mat-icon>{{ isEditMode ? "save" : "add" }}</mat-icon>
    {{ isEditMode ? "Update" : "Create" }} Watch List
  </button>
</mat-dialog-actions>
