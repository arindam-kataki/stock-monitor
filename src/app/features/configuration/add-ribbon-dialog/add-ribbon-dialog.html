<!-- src/app/features/configuration/add-ribbon-dialog/add-ribbon-dialog.html -->

<h2 mat-dialog-title>
  <mat-icon>{{ isEditMode ? "edit" : "add_circle" }}</mat-icon>
  {{ isEditMode ? "Edit" : "Create New" }} Watch List
</h2>

<mat-dialog-content>
  <form [formGroup]="ribbonForm">
    <!-- Ribbon Name -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Watch List Name</mat-label>
      <input
        matInput
        formControlName="name"
        placeholder="e.g., Tech Growth, Banking Sector"
        #nameInput
        autocomplete="off"
      />
      <mat-icon matSuffix>label</mat-icon>
      <mat-hint>Give your watch list a descriptive name</mat-hint>
      <mat-error *ngIf="ribbonForm.get('name')?.hasError('required')">
        Name is required
      </mat-error>
      <mat-error *ngIf="ribbonForm.get('name')?.hasError('minlength')">
        Name must be at least 2 characters
      </mat-error>
    </mat-form-field>

    <!-- Category Selection -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Category Template</mat-label>
      <mat-select formControlName="categoryId">
        <mat-option *ngFor="let category of categories" [value]="category.id">
          <span class="category-option">
            <span class="category-icon">{{ category.icon }}</span>
            <span class="category-name">{{ category.name }}</span>
            <span class="stock-count"
              >({{ category.stocks.length }} stocks)</span
            >
          </span>
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>category</mat-icon>
      <mat-hint>Choose a category to see available stocks</mat-hint>
      <mat-error *ngIf="ribbonForm.get('categoryId')?.hasError('required')">
        Please select a category
      </mat-error>
    </mat-form-field>

    <!-- Stock Selection Section -->
    <div class="stocks-section" *ngIf="selectedCategory">
      <!-- Header with controls -->
      <div class="stocks-header">
        <div class="header-left">
          <h3>
            Select Stocks & Set Alerts
            <mat-chip class="selection-chip">
              {{ selectedStockCount }} / {{ totalStockCount }} selected
            </mat-chip>
          </h3>
        </div>

        <div class="header-right">
          <!-- Search -->
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search stocks</mat-label>
            <input
              matInput
              [(ngModel)]="searchQuery"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Symbol or name..."
            />
            <button
              mat-icon-button
              matSuffix
              *ngIf="searchQuery"
              (click)="clearSearch()"
            >
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </div>

      <!-- Progress Bar -->
      <mat-progress-bar
        mode="determinate"
        [value]="selectionProgress"
        class="selection-progress"
      ></mat-progress-bar>

      <!-- Compact Stock List -->
      <div class="stock-list-compact">
        <div
          *ngFor="let stock of filteredStocks"
          class="stock-item-compact"
          [class.selected]="
            stockSelections[stock.symbol] &&
            stockSelections[stock.symbol].selected
          "
          [attr.data-symbol]="stock.symbol"
        >
          <!-- Main row with checkbox and values -->
          <div class="stock-item-row">
            <!-- Left Section: Checkbox + Stock Info -->
            <div class="stock-left-section">
              <mat-checkbox
                [checked]="
                  stockSelections[stock.symbol] &&
                  stockSelections[stock.symbol].selected
                "
                (change)="toggleStock(stock.symbol)"
                class="stock-checkbox-compact"
              >
                <div class="stock-info-compact">
                  <span class="stock-symbol">{{ stock.symbol }}</span>
                  <span class="stock-name">{{ stock.name }}</span>
                </div>
              </mat-checkbox>
            </div>

            <!-- Right Section: High/Low Values -->
            <div class="alert-values-compact">
              <!-- High Value -->
              <div class="alert-value-wrapper">
                <mat-icon class="alert-icon high">trending_up</mat-icon>
                <span
                  class="alert-value editable"
                  contenteditable="true"
                  (blur)="onAlertValueChange(stock.symbol, 'high', $event)"
                  (keydown)="onAlertValueKeydown($event)"
                  [attr.data-placeholder]="'High'"
                  >{{
                    formatAlertValue(stockSelections[stock.symbol]?.highValue)
                  }}</span
                >
              </div>

              <!-- Low Value -->
              <div class="alert-value-wrapper">
                <mat-icon class="alert-icon low">trending_down</mat-icon>
                <span
                  class="alert-value editable"
                  contenteditable="true"
                  (blur)="onAlertValueChange(stock.symbol, 'low', $event)"
                  (keydown)="onAlertValueKeydown($event)"
                  [attr.data-placeholder]="'Low'"
                  >{{
                    formatAlertValue(stockSelections[stock.symbol]?.lowValue)
                  }}</span
                >
              </div>

              <!-- Current Price -->
              <div class="current-price-compact" *ngIf="stock.price">
                <span class="price-label">Now:</span>
                <span class="price-value"
                  >${{ stock.price | number : "1.2-2" }}</span
                >
              </div>
            </div>
          </div>

          <!-- Inline validation error for this stock -->
          <div
            class="stock-validation-error"
            *ngIf="validationErrors[stock.symbol]"
          >
            <mat-icon class="error-icon">warning</mat-icon>
            <span>{{ validationErrors[stock.symbol] }}</span>
          </div>
        </div>

        <!-- No results message -->
        <div *ngIf="filteredStocks.length === 0" class="no-results">
          <mat-icon>search_off</mat-icon>
          <p>No stocks found matching your criteria</p>
        </div>
      </div>

      <!-- Quick Selection Chips -->
      <div class="quick-select-chips">
        <span class="chip-label">Quick actions:</span>
        <mat-chip-listbox>
          <mat-chip-option (click)="selectTopN(5)">Top 5</mat-chip-option>
          <mat-chip-option (click)="selectTopN(10)">Top 10</mat-chip-option>
          <mat-chip-option (click)="selectByPattern('inverse')"
            >Invert</mat-chip-option
          >
          <mat-chip-option (click)="deselectAll()" color="warn"
            >Clear All</mat-chip-option
          >
          <mat-chip-option
            (click)="showOnlySelected = !showOnlySelected"
            [class.active-filter]="showOnlySelected"
          >
            <mat-icon>{{
              showOnlySelected ? "visibility" : "visibility_off"
            }}</mat-icon>
            Show Selected
          </mat-chip-option>
        </mat-chip-listbox>
      </div>
    </div>

    <!-- Warning if no stocks selected -->
    <div
      class="warning-message"
      *ngIf="selectedCategory && selectedStockCount === 0"
    >
      <mat-icon>warning</mat-icon>
      <span>Please select at least one stock to create the watch list</span>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="!isFormValid || true"
  >
    <mat-icon>{{ isEditMode ? "save" : "add" }}</mat-icon>
    {{ isEditMode ? "Update" : "Create" }} Watch List
  </button>
</mat-dialog-actions>
